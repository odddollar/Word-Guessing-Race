<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
</head>
<body>
    <h1>Word Guessing Race</h1>
    <div id="game">
        <h2 id="word"></h2>
        <input type="text" id="guess">
    </div>
    <table id="scoreboard">
        <tr>
            <th>Username</th>
            <th>Score</th>
        </tr>
    </table>

    <script>
        // passed to page with server templating engine
        const username = "{{.Username}}";

        // list of words passed to page with server templating engine
        // then converted to json object/array
        const words = JSON.parse('{{.WordList}}');
        const totalWords = words.length;
        let wordIndex = parseInt("{{.Score}}", 10);

        // set initial word on page load
        let currentWord = document.getElementById("word")
        currentWord.innerText = words[wordIndex];

        // check guess on input change
        const guessBox = document.getElementById("guess");
        guessBox.addEventListener("keypress", e => {
            checkGuess(guessBox.value);
        })

        // update scoreboard every X period of time
        let scoreRefresh = setInterval(() => {
            getScoreboardJSON().then(res => {
                console.log(res);

                // remove old scoreboard and replace with updated one
                removeChildren(document.getElementById("scoreboard"), 1);
                addScoreboardRows(res);

                // check if there's a winner
                checkWinner(res);
            })
        }, 2000);
        
        // return promise that will resolve to json data
        function getScoreboardJSON() {
            return fetch("http://localhost:8080/score", {
                method: "GET",
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                },
            }).then(res => res.json())
            .catch(e => console.log("Error: ", e));
        }

        // take json data and add rows to scoreboard table
        function addScoreboardRows(json) {
            const scores = JSON.parse(json);
            for (score of scores) {
                addScoreboardRow(score);
            }
        }

        function addScoreboardRow(row) {
            // get constants to append together
            const sb = document.getElementById("scoreboard");
            const newRow = document.createElement("tr");

            // create new table row and set data
            const name = document.createElement("td")
            name.innerText = row.name;
            newRow.appendChild(name);
            const score = document.createElement("td");
            score.innerText = row.score;
            newRow.appendChild(name);
            newRow.appendChild(score);

            // append new row to parent table element
            sb.appendChild(newRow);
        }

        // iterate through child elements of node and remove all but first
        function removeChildren(element, remaining) {
            let child = element.lastElementChild;
            while (element.childElementCount > remaining) {
                element.removeChild(child);
                child = element.lastElementChild;
            }
        }

        function checkWinner(json) {
            // iterate through all users and check for winner
            for (user of JSON.parse(json)) {
                if (user.score == totalWords) {
                    // stop pinging server for score data
                    clearInterval(scoreRefresh);
                    
                    // display winner
                    displayWinner(user.name);
                }
            }
        }

        function displayWinner(winnerName) {
            const game = document.getElementById("game");

            // remove game elements
            removeChildren(game, 0);

            // add winner elements
            const banner = document.createElement("p");
            banner.innerText = winnerName + " won!";

            game.appendChild(banner);
        }

        function checkGuess(guess) {
            if (guess == words[wordIndex]) {
                // update to new word
                wordIndex++;
                currentWord.innerText = words[wordIndex];
                guessBox.value = "";

                // post completion status back to server to update score
                updateScore();
            }
        }

        // post username as json to api endpoint to register completed word
        function updateScore() {
            fetch("http://localhost:8080/score", {
                method: "POST",
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                },
                body: JSON.stringify({
                    name: username,
                })
            }).catch(e => console.error("Error: ", e));
        }
    </script>
</body>
</html>
